name: Daily Cleanup

on:
  schedule:
    # Ex√©cuter tous les jours √† 2h00 UTC (3h00 heure fran√ßaise)
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: europe-west1
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Execute Cleanup Job
        run: |
          echo "üßπ Ex√©cution du nettoyage quotidien..."
          
          # Ex√©cuter le job de nettoyage g√©n√©rique
          # Les variables d'environnement sont d√©j√† configur√©es dans le job via deploy.yml
          gcloud run jobs execute file-cleanup-job \
            --region=${{ env.REGION }} \
            --wait
          
          echo "‚úÖ Nettoyage quotidien termin√©"

      - name: Show Cleanup Summary
        run: |
          echo "üìä R√©sum√© du nettoyage:"
          echo "- Fichiers RGPD expir√©s supprim√©s"
          echo "- Anciens enregistrements de queue nettoy√©s"
          echo "- Conversations (howana_conversations) de plus de 3 jours supprim√©es"
          echo "- R√©ponses IA (ai_responses) de plus de 3 jours supprim√©es"
          echo "- Espace de stockage optimis√©"
